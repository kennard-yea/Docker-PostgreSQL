version: "3.9"
services:
    pgadmin:
        image: internal/pgadmin
        env_file:
            - pgadmin/pgadmin.env
        networks:
            db-net:
                aliases:
                    - pgadmin
        ports:
            - target: 80
              published: 8080
              protocol: tcp
              mode: host
        volumes:
            - type: volume
              source: pgadmin-vol
              target: /var/lib/pgadmin
    db1:
        image: internal/db1
        environment:
            POSTGRES_PASSWORD_FILE: /run/secrets/db1_postgres_password_file
            POSTGRES_USER: postgres
            POSTGRES_DB: postgres
            PGDATA: /var/lib/postgresql/data
            PGPORT: 5432
            PGBENCH_PASSWORD_FILE: /run/secrets/db1_pgbench_password_file
            PGBENCH_USER: pgbench
            PGBENCH_DB: pgbench
            PGBENCH_SCALE: 10
        networks:
            db-net:
                aliases:
                    - pgdb1
        ports:
            - target: 5432
              published: 54321
              protocol: tcp
              mode: host
        volumes:
            - type: volume
              source: db1-data-vol-v13
              target: /var/lib/postgresql/data
        secrets:
            - db1_postgres_password_file
            - db1_pgbench_password_file
    db2:
        image: internal/db2
        environment:
            POSTGRES_USER: postgres
            POSTGRES_DB: postgres
            PGDATA: /var/lib/postgresql/data
            PGPORT: 5432
            POSTGRES_PRIMARY_HOST: pgdb1
        depends_on:
            - db1
        networks:
            db-net:
                aliases:
                    - pgdb2
        volumes:
            - type: volume
              source: db2-data-vol-v13
              target: /var/lib/postgresql/data
    db3:
        image: internal/db3
        environment:
            POSTGRES_PASSWORD_FILE: /run/secrets/db3_postgres_password_file
            POSTGRES_USER: postgres
            POSTGRES_DB: postgres
            PGDATA: /var/lib/postgresql/data
            PGPORT: 5432
            PGLIB: /var/lib/postgresql/lib/
        networks:
            db-net:
                aliases:
                    - pgdb3
        volumes:
            - type: volume
              source: db3-data-vol-v13
              target: /var/lib/postgresql/data
        secrets:
            - db3_postgres_password_file
            - db3_pgbench_password_file
    zabbix-db:
        image: postgres:14
        environment:
            POSTGRES_PASSWORD_FILE: /run/secrets/zabbix_db_password_file
            POSTGRES_USER: zabbix
            POSTGRES_DB: zabbix
        networks:
            zabbix-net:
                aliases:
                  - zabbix-db-01
        secrets:
          - zabbix_db_password_file
    zabbix-server:
        image: zabbix/zabbix-server-pgsql:ubuntu-latest
        environment:
            DB_SERVER_HOST: zabbix-db-01
            POSTGRES_USER: zabbix
            POSTGRES_PASSWORD_FILE: /run/secrets/zabbix_db_password_file
            POSTGRES_DB: zabbix
        networks:
            zabbix-net:
                aliases:
                  - zabbix-server-01
        secrets:
          - zabbix_db_password_file
    zabbix-frontend:
        image: zabbix/zabbix-web-apache-pgsql:ubuntu-latest
        environment:
            DB_SERVER_HOST: zabbix-db-01
            POSTGRES_USER: zabbix
            POSTGRES_PASSWORD_FILE: /run/secrets/zabbix_db_password_file
            ZBX_SERVER_HOST: zabbix-server-01
            PHP_TZ: America/New_York
        secrets:
          - zabbix_db_password_file
        networks:
            zabbix-net:
                aliases:
                  - zabbix-frontend-01
        ports:
            - target: 8080
              published: 80
              protocol: tcp
              mode: host
            - target: 8443
              published: 443
              protocol:  tcp
              mode: host

volumes:
    db1-data-vol-v13:
    db2-data-vol-v13:
    db3-data-vol-v13:
    pgadmin-vol:
networks:
    db-net:
        driver: overlay
        attachable: true
    zabbix-net:
        driver: overlay
        attachable: true

secrets:
    db1_postgres_password_file:
        file: ./db1/.postgres_password
    db3_postgres_password_file:
        file: ./db3/.postgres_password
    db1_pgbench_password_file:
        file: ./db1/.pgbench_password
    db3_pgbench_password_file:
        file: ./db3/.pgbench_password
    zabbix_db_password_file:
        file: ./zabbix-db/.zabbix_db_password
